<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>IDEE - Acceso alumnos y maestros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- CSS general -->
  <link rel="stylesheet" href="css/login.css" />
</head>

<body>

  <!-- CONTENEDOR PRINCIPAL -->
  <div class="login-wrapper">


    <div class="login-wrapper">
      <div class="card card-login shadow-lg">
        <div class="card-body p-4 p-md-5">

          <div class="text-center mb-4">
            <img src="assets/logo.png" class="login-logo" alt="IDEE logo" />
          </div>

          <h5 class="mb-3 text-center fw-bold text-primary-ide">Acceso alumnos y maestros</h5>

          <p class="text-muted small text-center mb-4">
            Portal de consulta acad√©mica, horarios, asignaturas y evaluaci√≥n docente.
          </p>

          <form id="userLoginForm">
            <div id="loginFeedback" class="alert d-none" role="alert"></div>
            <div class="mb-3">
              <label class="form-label">Correo institucional</label>
              <input type="email" class="form-control" id="userEmail"
                placeholder="alumno@idee.edu.mx / maestro@idee.edu.mx" required />
            </div>

            <div class="mb-2 position-relative">
              <label class="form-label">Contrase√±a</label>
              <input type="password" class="form-control" id="userPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
              <button type="button" class="toggle-password" onclick="togglePassword()">
                üëÅ
              </button>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="form-check small">
                <input class="form-check-input" type="checkbox" id="rememberCheck" />
                <label class="form-check-label" for="rememberCheck">
                  Mantener sesi√≥n
                </label>
              </div>

              <a href="#" class="small link-ide text-decoration-none">
                No recuerdo mi contrase√±a
              </a>
            </div>

            <button type="submit" class="btn btn-ide w-100 py-2">
              Ingresar
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Redirigir si ya est√° autenticado (con validaci√≥n estricta)
    console.log('=== Verificando autenticaci√≥n en index.html ===');
    console.log('localStorage.getItem("token"):', localStorage.getItem('token'));
    console.log('localStorage.getItem("userTipo"):', localStorage.getItem('userTipo'));
    console.log('isAuthenticated():', isAuthenticated());

    if (isAuthenticated()) {
      const userTipo = localStorage.getItem('userTipo');
      const token = localStorage.getItem('token');
      console.log('‚úÖ Usuario autenticado:');
      console.log('  - Token existe:', !!token);
      console.log('  - Tipo usuario:', userTipo);
      
      if (userTipo) {
        console.log('üìç Redirigiendo a p√°gina de:', userTipo);
        redirectByUserType(userTipo);
      } else {
        console.warn('‚ö†Ô∏è No hay tipo de usuario, limpiando sesi√≥n');
        logout();
      }
    } else {
      console.log('‚ùå No hay autenticaci√≥n v√°lida, mostrando login');
    }

    // Manejar el formulario de login
    document.getElementById("userLoginForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const email = document.getElementById("userEmail").value.trim();
      const password = document.getElementById("userPassword").value.trim();
      const submitBtn = document.querySelector('button[type="submit"]');
      const feedback = document.getElementById('loginFeedback');

      // Validar que ambos campos est√©n llenos
      if (!email || !password) {
        mostrarLoginFeedback('Por favor ingresa email y contrase√±a', 'warning');
        return;
      }

      // Deshabilitar el bot√≥n mientras se procesa
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Ingresando...';
      feedback.classList.add('d-none');

      try {
        console.log('üîê Iniciando login para:', email);
        const data = await login(email, password); // Usa la funci√≥n de auth.js
        console.log('‚úÖ Login exitoso, datos recibidos:', data);
        console.log('üíæ Token en localStorage:', localStorage.getItem('token'));

        mostrarLoginFeedback(`üéâ ¬°Bienvenido ${data.email}!`, 'success');

        setTimeout(() => {
          console.log('üìç Redirigiendo a:', data.tipoUsuario);
          redirectByUserType(data.tipoUsuario);
        }, 800);

      } catch (error) {
        console.error('‚ùå Error en login:', error.message);
        console.error('üìã Respuesta del servidor completa:', error);
        
        // Limpiar cualquier dato residual de intentos fallidos
        console.warn('üóëÔ∏è Limpiando datos residuales de localStorage');
        localStorage.removeItem('token');
        localStorage.removeItem('userTipo');
        localStorage.removeItem('userEmail');
        localStorage.removeItem('userId');

        let mensajeError = error.message || 'Credenciales incorrectas';
        if (error.message.includes('Usuario no encontrado')) {
          mensajeError = '‚ùå Usuario no registrado en el sistema';
        } else if (error.message.includes('Credenciales incorrectas') || error.message.includes('Access Denied')) {
          mensajeError = '‚ùå Email o contrase√±a incorrectos';
        } else if (error.message.includes('Usuario inactivo')) {
          mensajeError = '‚ùå Usuario inactivo. Contacta con administraci√≥n';
        } else if (error.message.includes('403')) {
          mensajeError = '‚ùå Acceso denegado. Verifica tus credenciales o contacta a administraci√≥n';
        }

        mostrarLoginFeedback(mensajeError, 'danger');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ingresar';
      }
    });

    // Funci√≥n para mostrar/ocultar contrase√±a
    function togglePassword() {
      const passwordInput = document.getElementById('userPassword');
      const toggleBtn = document.querySelector('.toggle-password');

      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleBtn.textContent = 'üôà';
      } else {
        passwordInput.type = 'password';
        toggleBtn.textContent = 'üëÅ';
      }
    }

    function mostrarLoginFeedback(mensaje, tipo) {
      const feedback = document.getElementById('loginFeedback');
      if (!feedback) return;

      feedback.textContent = mensaje;
      feedback.className = `alert alert-${tipo}`;
      feedback.classList.remove('d-none');
    }
  </script>

</body>

</html>
